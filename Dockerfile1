# Use an Alpine base image with OpenJDK 17
FROM openjdk:17-alpine

# Install necessary packages and tools
RUN apk update && \
    apk add --no-cache wget tar bash

# Set environment variables
ENV CATALINA_HOME /opt/apache-tomcat-9.0.65
ENV JAVA_HOME /usr/lib/jvm/java-17-openjdk
ENV PATH $PATH:$JAVA_HOME/bin

# Download and extract Apache Tomcat
RUN wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.65/bin/apache-tomcat-9.0.65.tar.gz -P /tmp && \
    tar xfz /tmp/apache-tomcat-9.0.65.tar.gz -C /opt && \
    rm /tmp/apache-tomcat-9.0.65.tar.gz && \
    ln -s $CATALINA_HOME/bin/startup.sh /usr/bin/startTomcat && \
    ln -s $CATALINA_HOME/bin/shutdown.sh /usr/bin/stopTomcat

# Add manager and host-manager changes
RUN sed -i 's/<Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/>/<!-- <Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/> -->/' $CATALINA_HOME/webapps/manager/META-INF/context.xml && \
    sed -i 's/<Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/>/<!-- <Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/> -->/' $CATALINA_HOME/webapps/host-manager/META-INF/context.xml

# Add admin user to tomcat-users.xml
RUN echo '<user username="admin" password="admin1234" roles="admin-gui, manager-gui, manager-script" />' >> $CATALINA_HOME/conf/tomcat-users.xml

# Expose ports
EXPOSE 8287

# Create a non-root user and switch to that user
RUN adduser -D -s /bin/bash tomcat && \
    chown -R tomcat:tomcat $CATALINA_HOME
USER tomcat

# Start Tomcat
CMD ["catalina.sh", "run"]
