# Use Tomcat Alpine base image with OpenJDK 17
FROM tomcat:latest

# Set environment variables
ENV CATALINA_HOME /usr/local/tomcat
ENV JAVA_HOME /usr/lib/jvm/java-17-openjdk
ENV PATH $PATH:$JAVA_HOME/bin

# Add manager and host-manager changes
RUN sed -i 's/<Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/>/<!-- <Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/> -->/' $CATALINA_HOME/webapps/manager/META-INF/context.xml && \
    sed -i 's/<Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/>/<!-- <Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127\\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" \/> -->/' $CATALINA_HOME/webapps/host-manager/META-INF/context.xml

# Add admin user to tomcat-users.xml
RUN sed -i '/<\/tomcat-users>/i <user username="${TOMCAT_USER}" password="${TOMCAT_PASSWORD}" roles="admin-gui, manager-gui, manager-script" />' $CATALINA_HOME/conf/tomcat-users.xml

# Copy webapps from webapps.dist to webapps
COPY webapps.dist /tmp/webapps.dist
RUN mkdir -p $CATALINA_HOME/webapps && \
    cp -R /tmp/webapps.dist/* $CATALINA_HOME/webapps

# Expose ports
EXPOSE 8287

# Create a non-root user and switch to that user
RUN adduser -D -s /bin/sh tomcat && \
    chown -R tomcat:tomcat $CATALINA_HOME
USER tomcat

# Start Tomcat
CMD ["catalina.sh", "run"]
